<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Oc√©ane Control Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            height: 100vh; /* Prend tout l'√©cran */
            overflow: hidden; /* Pas de scroll global */
            display: flex;
            flex-direction: column;
        }

        /* --- ZONE HAUTE (MONITORING) --- */
        #top-zone {
            flex: 0 0 65%; /* Prend 65% de la hauteur */
            padding: 10px;
            overflow: hidden;
        }

        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            background-color: #252525;
            border-bottom: 1px solid #333;
            font-weight: bold;
            color: #4db8ff;
            padding: 5px 10px;
        }

        .card-body {
            overflow-y: auto; /* Scroll interne uniquement */
            flex-grow: 1;
            padding: 10px;
            font-size: 0.85rem;
        }

        /* --- ZONE BASSE (COMMANDES) --- */
        #bottom-zone {
            flex: 1; /* Prend le reste (35%) */
            background-color: #181818;
            border-top: 2px solid #444;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        /* --- STYLES SP√âCIFIQUES --- */
        .progress { height: 4px; background-color: #333; margin-top: 2px; margin-bottom: 8px;}
        .bar-activation { background-color: #ff00ff; }
        .node-row { border-bottom: 1px solid #2a2a2a; padding: 4px 0; }

        .log-entry { margin-bottom: 6px; border-left: 3px solid #555; padding-left: 8px; }
        .tag-badge { background: #333; padding: 1px 4px; border-radius: 3px; font-size: 0.75em; color: #aaa; }

        .llm-box { background: #111; padding: 8px; margin-bottom: 10px; border: 1px solid #333; font-size: 0.8rem; white-space: pre-wrap; }

        /* Bouton PTT Gigantesque */
        #btn-ptt {
            height: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.1s;
        }
        #btn-ptt:active { transform: scale(0.98); box-shadow: none; }

        /* Input Texte Console */
        #input-text {
            background-color: #000;
            border: 1px solid #555;
            color: #0f0;
            font-family: 'Consolas', monospace;
            font-size: 1.1rem;
            flex-grow: 1; /* Prend toute la hauteur dispo dans la zone basse */
            resize: none;
        }
        #input-text:focus { outline: none; border-color: #0f0; box-shadow: 0 0 10px rgba(0, 255, 0, 0.2); }

        /* Scrollbars fines */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

<!-- ZONE HAUTE : MONITORING (3 COLONNES) -->
<div id="top-zone" class="container-fluid">
    <div class="row h-100">
        <!-- COL 1 : CERVEAU + PTT -->
        <div class="col-md-3 d-flex flex-column h-100">
            <!-- PTT BUTTON (Au-dessus du cerveau) -->
            <button id="btn-ptt" class="btn btn-danger w-100">
                üîá PUSH TO TALK
            </button>

            <div class="card">
                <div class="card-header">üß† Activit√© Neurale</div>
                <div class="card-body" id="brain-container"></div>
            </div>
        </div>

        <!-- COL 2 : JOURNAL -->
        <div class="col-md-4 h-100">
            <div class="card">
                <div class="card-header">üìú Journal de Session</div>
                <div class="card-body" id="logs-container"></div>
            </div>
        </div>

        <!-- COL 3 : LLM -->
        <div class="col-md-5 h-100">
            <div class="card">
                <div class="card-header">ü§ñ LLM Inspector</div>
                <div class="card-body" id="llm-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- ZONE BASSE : COMMANDE TEXTUELLE -->
<div id="bottom-zone">
    <div class="d-flex justify-content-between mb-2">
        <span class="text-muted">TERMINAL DE COMMANDE / FLUX DE PENS√âE</span>
        <span class="text-success" style="font-size: 0.8em">‚óè SYST√àME EN LIGNE</span>
    </div>
    <textarea id="input-text" class="form-control"
              placeholder="Tapez ici pour injecter une pens√©e ou une commande... (Shift+Entr√©e pour saut de ligne, Entr√©e pour envoyer)"></textarea>
</div>

<script>
    // --- MOTEUR D'AFFICHAGE ---
    async function updateDashboard() {
        // 1. Brain
        try {
            const resBrain = await fetch('/api/brain');
            const dataBrain = await resBrain.json();
            const brainDiv = document.getElementById('brain-container');
            let html = "";
            if(dataBrain.nodes) {
                // On affiche max 30 noeuds pour pas saturer
                dataBrain.nodes.slice(0, 30).forEach(node => {
                    let styleTitle = node.activation > 1.0 ? "color: #fff; font-weight:bold; text-shadow: 0 0 5px #fff;" : "color: #888;";
                    let icon = node.ignited ? "üî•" : "";
                    html += `
                    <div class="node-row">
                        <div class="d-flex justify-content-between">
                            <span style="${styleTitle}">${icon} ${node.title}</span>
                            <span class="text-muted" style="font-size:0.8em">W:${node.weight}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bar-activation" style="width: ${Math.min(node.activation * 10, 100)}%"></div>
                        </div>
                    </div>`;
                });
            }
            brainDiv.innerHTML = html;
        } catch(e) {}

        // 2. Logs
        try {
            const resLogs = await fetch('/api/logs');
            const dataLogs = await resLogs.json();

            // Journal
            const logsDiv = document.getElementById('logs-container');
            let logHtml = "";
            if (dataLogs.journal) {
                dataLogs.journal.forEach(log => {
                    let color = "#555"; // IA D√©faut
                    if(log.source === "Clavier") color = "#00ccff"; // Bleu Cyan
                    else if(log.source === "user" || log.source === "Utilisateur") color = "#00cc00"; // Vert
                    else if(log.source === "Analyste") color = "#ff9900"; // Orange

                    logHtml += `
                    <div class="log-entry" style="border-left-color:${color}">
                        <div>
                            <span class="text-muted" style="font-size:0.7em">[${log.timestamp.substring(11, 19)}]</span>
                            <span class="tag-badge">${log.intent_tag}</span>
                        </div>
                        <div style="color:${log.source === 'Clavier' ? '#00ccff' : '#ddd'}">${log.text}</div>
                    </div>`;
                });
            }
            logsDiv.innerHTML = logHtml;

            // LLM
            const llmDiv = document.getElementById('llm-container');
            let llmHtml = "";
            if (dataLogs.llm) {
                dataLogs.llm.forEach(trace => {
                    let typeClass = trace.type === "INPUT" ? "text-warning" : "text-info";
                    llmHtml += `
                    <div class="llm-box">
                        <span class="${typeClass}" style="font-weight:bold">${trace.type}</span>
                        <div style="opacity:0.8">${trace.content}</div>
                    </div>`;
                });
            }
            llmDiv.innerHTML = llmHtml;

        } catch(e) {}
    }

    // --- LOGIQUE PTT ---
    const btnPtt = document.getElementById('btn-ptt');

    const startPtt = () => {
        btnPtt.classList.remove('btn-danger');
        btnPtt.classList.add('btn-success');
        btnPtt.innerHTML = "üéôÔ∏è ENREGISTREMENT...";
        fetch('/api/control/ptt/start', {method: 'POST'});
    };

    const stopPtt = () => {
        btnPtt.classList.remove('btn-success');
        btnPtt.classList.add('btn-danger');
        btnPtt.innerHTML = "üîá PUSH TO TALK";
        fetch('/api/control/ptt/stop', {method: 'POST'});
    };

    btnPtt.addEventListener('mousedown', startPtt);
    btnPtt.addEventListener('mouseup', stopPtt);
    btnPtt.addEventListener('mouseleave', () => {
        if (btnPtt.classList.contains('btn-success')) stopPtt();
    });

    // --- LOGIQUE TEXTE (CHAT) ---
    const inputTxt = document.getElementById('input-text');

    inputTxt.addEventListener('keydown', async (e) => {
        // Envoi avec Entr√©e (sans Shift)
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Emp√™che le saut de ligne
            const text = inputTxt.value.trim();
            if (text) {
                inputTxt.value = ""; // Clear
                await fetch('/api/input/text', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text})
                });
                setTimeout(updateDashboard, 500); // Feedback rapide
            }
        }
    });

    // Refresh auto
    setInterval(updateDashboard, 1000);
    updateDashboard();
</script>
</body>
</html>