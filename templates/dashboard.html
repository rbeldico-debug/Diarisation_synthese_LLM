<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>OcÃ©ane Control Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Consolas', monospace; font-size: 0.9rem; }
        .card { background-color: #1e1e1e; border: 1px solid #333; margin-bottom: 20px; height: 90vh; display: flex; flex-direction: column; }
        .card-header { background-color: #252525; border-bottom: 1px solid #333; font-weight: bold; color: #4db8ff; }
        .card-body { overflow-y: auto; flex-grow: 1; padding: 10px; }

        /* Cerveau */
        .progress { height: 6px; background-color: #333; margin-top: 5px; }
        .bar-activation { background-color: #ff00ff; }
        .bar-weight { background-color: #00cc00; }
        .node-row { border-bottom: 1px solid #2a2a2a; padding: 8px 0; }

        /* Logs */
        .log-entry { margin-bottom: 8px; border-left: 3px solid #555; padding-left: 8px; }
        .log-user { border-left-color: #00cc00; }
        .log-ia { border-left-color: #ff00ff; }
        .tag-badge { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: #aaa; }

        /* LLM */
        .llm-box { background: #181818; padding: 10px; margin-bottom: 15px; border: 1px solid #333; border-radius: 5px; white-space: pre-wrap; }
        .llm-input { border-left: 3px solid #ffcc00; }
        .llm-output { border-left: 3px solid #00ccff; }
        .llm-label { font-size: 0.7em; text-transform: uppercase; margin-bottom: 5px; display: block; opacity: 0.7; }
    </style>
</head>
<body class="p-3">

<div class="container-fluid">
    <div class="row">
        <!-- COLONNE 1 : CERVEAU -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">ðŸ§  ActivitÃ© Neurale</div>
                <div class="card-body" id="brain-container">
                    <!-- Rempli par JS -->
                </div>
            </div>
        </div>

        <!-- COLONNE 2 : LOGS SYSTÃˆME -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">ðŸ“œ Journal de Session</div>
                <div class="card-body" id="logs-container">
                    <!-- Rempli par JS -->
                </div>
            </div>
        </div>

        <!-- COLONNE 3 : INSPECTION LLM -->
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">ðŸ¤– LLM Inspector (Input/Output)</div>
                <div class="card-body" id="llm-container">
                    <!-- Rempli par JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function updateDashboard() {
        // 1. Update Brain
        try {
            const resBrain = await fetch('/api/brain');
            const dataBrain = await resBrain.json();
            const brainDiv = document.getElementById('brain-container');

            let html = "";
            if(dataBrain.nodes) {
                dataBrain.nodes.forEach(node => {
                    let fatigue = node.fatigue > 0 ? "ðŸ”¥" + node.fatigue : "";
                    let styleTitle = node.activation > 0 ? "color: #fff; font-weight:bold;" : "color: #888;";

                    html += `
                    <div class="node-row">
                        <div class="d-flex justify-content-between">
                            <span style="${styleTitle}">${node.title} ${fatigue}</span>
                            <span>W: ${node.total_weight}</span>
                        </div>
                        <div class="d-flex justify-content-between" style="font-size:0.8em; color:#aaa;">
                            <span>Act: ${node.activation}</span>
                            <span>Links: ${node.links}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bar-activation" style="width: ${Math.min(node.activation * 10, 100)}%"></div>
                        </div>
                    </div>`;
                });
            }
            brainDiv.innerHTML = html;
        } catch(e) { console.error(e); }

        // 2. Update Logs & LLM
        try {
            const resLogs = await fetch('/api/logs');
            const dataLogs = await resLogs.json();

            // Logs
            const logsDiv = document.getElementById('logs-container');
            let logHtml = "";
            if (dataLogs.journal) {
                dataLogs.journal.forEach(log => {
                    let borderClass = log.source === "user" ? "log-user" : "log-ia";
                    let time = log.timestamp.substring(11, 19);
                    logHtml += `
                    <div class="log-entry ${borderClass}">
                        <div><span class="text-muted">[${time}]</span> <span class="tag-badge">${log.intent_tag}</span></div>
                        <div>${log.text}</div>
                    </div>`;
                });
            }
            logsDiv.innerHTML = logHtml;

            // LLM
            const llmDiv = document.getElementById('llm-container');
            let llmHtml = "";
            if (dataLogs.llm) {
                dataLogs.llm.forEach(trace => {
                    let typeClass = trace.type === "INPUT" ? "llm-input" : "llm-output";
                    llmHtml += `
                    <div class="llm-box ${typeClass}">
                        <span class="llm-label text-${trace.type === "INPUT" ? "warning" : "info"}">${trace.type} | ${trace.timestamp}</span>
                        ${trace.content}
                    </div>`;
                });
            }
            llmDiv.innerHTML = llmHtml;

        } catch(e) { console.error(e); }
    }

    // Rafraichissement toutes les 1s
    setInterval(updateDashboard, 1000);
    updateDashboard();
</script>
</body>
</html>